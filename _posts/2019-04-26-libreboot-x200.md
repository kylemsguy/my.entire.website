---
layout: post
title: Flashing Libreboot on my ThinkPad X200
comments: true
---
Something I've wanted to do for the past little while was to flash Coreboot/Libreboot onto a laptop. Recently, I got the chance when I saw a relatively cheap X200 on eBay. The only problem was, I needed a few more things before I could get started:

- SOIC-16 Clip (only found out which clip I needed when I got the laptop and took it apart)
- CH341A USB SPI flasher (I have a Raspberry Pi, but it was cheap)

I ordered these from China off Aliexpress, and they arrived a couple of weeks later via EMS (I also ordered an SOIC-8 clip for flashing my X230--more to come later, perhaps). Thus, my adventures began.

The first thing I did with the SOIC-16 clip was to check which pin was connected to which pin on the included header (the wires soldered to the clip terminated in a female connector, and included a male header adapter to fit into the socket of the CH341A) with my multimeter. I then plugged the header into the CH341A.

I then disassembled the X200 to reveal its flash chip, which was located under the palmrest. On my system, this was a Winbond flash chip "W25X64" (8192 kB, SPI), which is in an SOIC-16 package. The SOIC-16 clip I purchased had wires soldered onto it already, so I plugged it into the flasher and clipped it onto the chip, before plugging it into my Surface Go running Fedora 29. Result? 

No chip detected.

I double-checked that my connections were correct, and switched over to my Mac in case my Surface Go's USB-C hub needed to be plugged into the wall. Still no dice.

After some googling, I realized that the pinout of the CH341A was not the same as the SOIC-16 chip's. I would need to build an adapter to take the four SPI pins from the corners of the SOIC-16 chip, and adapt it to the CH341A's SOIC-8 pins. 

After I scrounged up some wire to do the conversion, and spent 20mins fighting with fiddly wires that easily fell out, I was once again ready to read the factory ROM. Result?

<Unknown SPI chip 0kb>

Well, at least it detected a chip this time. The problem this time was that the wires pre-soldered to my SOIC-16 chip were way too long (at least 10in), so I would need to either solder shorter wires to the SOIC-16 clip, or cut the wires shorter and shove them into the CH341A directly. I chose to do the latter, since I probably wouldn't use this clip for anything else.

After clipping the wires, I bundled the wires I didn't need (the middle 8), and stripped the ones I did (the wires corresponding to pins 1, 2, 7, 8, 9, 10, 15, 16). Then, I struggled to insert these wires with the following mappings into the CH341A:

SOIC-8 -> SOIC-16
1 -> 7
2 -> 8
3 -> 9
4 -> 10
5 -> 15
6 -> 16
7 -> 1
8 -> 2

(Thanks to (/u/Ryccardo) for the (pinout mapping)[https://www.reddit.com/r/thinkpad/comments/7ejz2t/flash_a_x200_with_a_ch341a_usb_flasher/dq7e7yk?utm_source=share&utm_medium=web2x])

It was quite a struggle to get the wires into the correct place without the previous ones falling out, but eventually I got them to stay long enough for me to lock them in. I still had to take care not to put too much strain on the wires, since the locking shutters on the socket were not very strong. 

I then gingerly plugged the CH341A into my Macbook, and attached the clip to the chip. I ran the following command a few times:
`flashrom -p ch341a_spi -r factory.rom`

Eventually, it worked, and read the contents of the ROM into factory.rom. I repeated this several more times and verified that they were all the same by comparing their SHA512 hashes. 


- talk about how wires kept disconnecting
- talk about scare when programming failed
- talk about restoring old BIOS to get mac address
- talk about using wrong file when attempting to replace mac address causing sys not to boot, and swapping ram in an attempt to get it to boot
- talk about flashing unmodified libreboot to finally get it to work
- talk about memtest 
- it works!